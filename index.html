<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro DDLC Textbox - Final Fix</title>
<style>
  :root {
    --textbox-width: 900px;
    --textbox-height: 200px;
    --accent: #f6a5c0;
    --bg-color: #111;
    --text-color: #222;
  }
  html,body { height:100%; margin:0; background:var(--bg-color); color:#fff; font-family: Arial, sans-serif; overflow: hidden; }
  #scene { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
  
  #bg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
    background: #000;
    transition: opacity 0.4s ease-in-out;
  }

  #portrait {
    position: absolute;
    right: 40px;
    bottom: 120px;
    width: 28vw;
    max-width: 420px;
    min-width: 160px;
    z-index: 2;
    display: none;
    pointer-events: none;
  }

  #textbox {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: var(--textbox-width);
    max-width: calc(100vw - 40px);
    height: var(--textbox-height);
    background: #fff;
    border-top: 6px solid var(--accent);
    border-radius: 10px 10px 0 0;
    padding: 18px 22px;
    box-sizing: border-box;
    display: none;
    color: var(--text-color);
    z-index: 3;
    cursor: pointer;
    box-shadow: 0 -5px 25px rgba(0,0,0,0.5);
  }

  #namebox {
    position: absolute;
    top: -36px;
    left: 20px;
    background: var(--accent);
    color: white;
    padding: 8px 16px;
    font-weight: bold;
    border-radius: 6px 6px 0 0;
    min-width: 80px;
    text-align: center;
  }

  #text { font-size: 22px; line-height: 1.4; white-space: pre-wrap; overflow: auto; height: 100%; color: var(--text-color); }
  #next { position: absolute; bottom: 10px; right: 20px; font-size: 12px; opacity: 0.5; color: var(--text-color); }

  @media (max-width: 600px) { #portrait { display: none; } #text { font-size: 18px; } }
</style>
</head>
<body>

<div id="scene">
  <img id="bg" alt="background" />
  <img id="portrait" alt="character portrait" />
</div>

<div id="textbox">
  <div id="namebox"></div>
  <div id="text"></div>
  <div id="next">â–¶</div>
</div>

<script>
/** CONFIG **/
const DIALOGUE_PATH = 'assets/dialogue.json';
const CHARACTER_DATA_PATH = 'assets/characters/katz/characterdata.json';
const BG_DATA_PATH = 'assets/bg/bgdata.json'; 

/** STATE **/
let dialogue = [];
let characterData = {};
let bgData = {};
let index = 0, charIndex = 0, typing = false;
const preloadedImages = new Set();

const textbox = document.getElementById('textbox');
const namebox = document.getElementById('namebox');
const textEl = document.getElementById('text');
const portrait = document.getElementById('portrait');
const bgImg = document.getElementById('bg');

/** PATH RESOLVER **/
function getFullUrl(key, dataObj, jsonSourcePath) {
  if (!key || !dataObj || !dataObj.list) return key;
  
  let fileName = dataObj.list[key];
  if (!fileName) return key; 
  if (typeof fileName === 'object') fileName = fileName.file;
  
  // Ensure extension
  if (!/(\.[a-zA-Z0-9]+)$/.test(fileName)) fileName += '.png';
  
  // Resolve Prefix:
  // If prefix starts with http or /, use it as absolute.
  // Otherwise, treat it as relative to the ROOT of your site.
  if (dataObj.prefix) {
    const p = dataObj.prefix.endsWith('/') ? dataObj.prefix : dataObj.prefix + '/';
    return p + fileName;
  } 
  
  // Fallback: use the JSON's own folder
  const lastSlash = jsonSourcePath.lastIndexOf('/');
  const baseDir = lastSlash >= 0 ? jsonSourcePath.substring(0, lastSlash + 1) : '';
  return baseDir + fileName;
}

function preload(url) {
  if (!url || preloadedImages.has(url)) return;
  const img = new Image();
  img.src = url;
  preloadedImages.add(url);
}

/** DATA LOADING **/
async function loadAll() {
  try {
    const [d, c, b] = await Promise.all([
      fetch(DIALOGUE_PATH).then(r => r.json()),
      fetch(CHARACTER_DATA_PATH).then(r => r.json()),
      fetch(BG_DATA_PATH).then(r => r.json())
    ]);

    dialogue = d.dialogue || d;
    characterData = c;
    bgData = b;

    if (dialogue.length > 0) {
      textbox.style.display = 'block';
      startLine();
    }
  } catch (e) {
    console.error("Load Error:", e);
    textEl.textContent = "Error loading files. Check console for path errors.";
    textbox.style.display = 'block';
  }
}

/** GAME ENGINE **/
function startLine() {
  typing = true;
  charIndex = 0;
  textEl.textContent = '';
  const line = dialogue[index];
  if (!line) return;

  namebox.textContent = line.name || '';
  namebox.style.display = line.name ? 'block' : 'none';

  // 1. PORTRAIT
  if (line.expression) {
    const portraitUrl = getFullUrl(line.expression, characterData, CHARACTER_DATA_PATH);
    console.log("Loading Portrait:", portraitUrl); // DEBUG: check console if it fails
    portrait.src = portraitUrl;
    portrait.style.display = 'block';
    portrait.onerror = () => { portrait.style.display = 'none'; };
  } else {
    portrait.style.display = 'none';
  }

  // 2. BACKGROUND
  if (line.bg) {
    const bgKey = (typeof line.bg === 'object') ? line.bg.file : line.bg;
    const newBgSrc = getFullUrl(bgKey, bgData, BG_DATA_PATH);
    
    if (!bgImg.src.includes(newBgSrc)) {
      bgImg.style.opacity = 0; 
      setTimeout(() => {
        bgImg.src = newBgSrc;
        bgImg.onload = () => { bgImg.style.opacity = 1; };
      }, 50);
    }
  }

  // 3. PRELOAD
  if (index + 1 < dialogue.length) {
    const next = dialogue[index + 1];
    if (next.expression) preload(getFullUrl(next.expression, characterData, CHARACTER_DATA_PATH));
    if (next.bg) {
      const nextKey = (typeof next.bg === 'object') ? next.bg.file : next.bg;
      preload(getFullUrl(nextKey, bgData, BG_DATA_PATH));
    }
  }

  type();
}

function type() {
  const fullText = dialogue[index]?.text || '';
  if (charIndex < fullText.length) {
    textEl.textContent += fullText.charAt(charIndex++);
    setTimeout(type, 30);
  } else {
    typing = false;
  }
}

function nextLine() {
  if (typing) {
    textEl.textContent = dialogue[index].text;
    typing = false;
    return;
  }
  index++;
  if (index < dialogue.length) startLine();
  else textbox.style.display = 'none';
}

/** INPUTS **/
window.addEventListener('click', () => { if(textbox.style.display !== 'none') nextLine(); });
window.addEventListener('keydown', (e) => {
  if (textbox.style.display === 'none') return;
  if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); nextLine(); }
});

loadAll();
</script>
</body>
</html>
