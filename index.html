<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro DDLC Textbox - JSON Integrated</title>
<style>
  :root {
    --textbox-width: 900px;
    --textbox-height: 200px;
    --accent: #f6a5c0;
    --bg-color: #111;
    --text-color: #222;
  }
  html,body { height:100%; margin:0; background:var(--bg-color); color:#fff; font-family: Arial, sans-serif; overflow: hidden; }
  #scene { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
  
  #bg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
    background: #000;
    transition: opacity 0.4s ease-in-out;
  }

  #portrait {
    position: absolute;
    right: 40px;
    bottom: 120px;
    width: 28vw;
    max-width: 420px;
    min-width: 160px;
    z-index: 2;
    display: none;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  #textbox {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: var(--textbox-width);
    max-width: calc(100vw - 40px);
    height: var(--textbox-height);
    background: #fff;
    border-top: 6px solid var(--accent);
    border-radius: 10px 10px 0 0;
    padding: 18px 22px;
    box-sizing: border-box;
    display: none;
    color: var(--text-color);
    z-index: 3;
    cursor: pointer;
    box-shadow: 0 -5px 25px rgba(0,0,0,0.5);
  }

  #namebox {
    position: absolute;
    top: -36px;
    left: 20px;
    background: var(--accent);
    color: white;
    padding: 8px 16px;
    font-weight: bold;
    border-radius: 6px 6px 0 0;
    min-width: 80px;
    text-align: center;
  }

  #text { font-size: 22px; line-height: 1.4; white-space: pre-wrap; overflow: auto; height: 100%; }
  #next { position: absolute; bottom: 10px; right: 20px; font-size: 12px; opacity: 0.5; }

  @media (max-width: 600px) { #portrait { display: none; } #text { font-size: 18px; } }
</style>
</head>
<body>

<div id="scene">
  <img id="bg" alt="background" />
  <img id="portrait" alt="character portrait" />
</div>

<div id="textbox" tabindex="0">
  <div id="namebox"></div>
  <div id="text"></div>
  <div id="next">â–¶</div>
</div>

<script>
/** CONFIG **/
const DIALOGUE_PATH = 'assets/dialogue.json';
const CHARACTER_DATA_PATH = 'assets/characters/katz/characterdata.json';
const BG_DATA_PATH = 'assets/bgs/bgdata.json'; 

/** STATE **/
let dialogue = [];
let characterData = {};
let bgData = {};
let index = 0, charIndex = 0, typing = false;
const preloadedImages = new Set();

const textbox = document.getElementById('textbox');
const namebox = document.getElementById('namebox');
const textEl = document.getElementById('text');
const portrait = document.getElementById('portrait');
const bgImg = document.getElementById('bg');

/** PATH RESOLVER **/
// Handles the mapping from the JSON "list" and "prefix"
function getFullUrl(key, dataObj) {
  if (!key || !dataObj || !dataObj.list) return key;
  
  let file = dataObj.list[key];
  if (!file) return key; // Fallback if key not in list
  
  if (typeof file === 'object') file = file.file;
  
  // Add .png if no extension exists
  if (!/(\.[a-zA-Z0-9]+)$/.test(file)) file += '.png';
  
  const prefix = dataObj.prefix || '';
  if (prefix) {
    const cleanPrefix = prefix.endsWith('/') ? prefix : prefix + '/';
    return cleanPrefix + file;
  }
  return file;
}

function preload(url) {
  if (!url || preloadedImages.has(url)) return;
  const img = new Image();
  img.src = url;
  preloadedImages.add(url);
}

/** DATA LOADING **/
async function loadAll() {
  try {
    const [d, c, b] = await Promise.all([
      fetch(DIALOGUE_PATH).then(r => r.json()),
      fetch(CHARACTER_DATA_PATH).then(r => r.json()),
      fetch(BG_DATA_PATH).then(r => r.json())
    ]);

    dialogue = d.dialogue || d;
    characterData = c;
    bgData = b;

    if (dialogue.length > 0) {
      textbox.style.display = 'block';
      startLine();
    }
  } catch (e) {
    console.error("Critical Load Error:", e);
    textEl.textContent = "Error: Could not load JSON data. Check file paths.";
    textbox.style.display = 'block';
  }
}

/** GAME ENGINE **/
function startLine() {
  typing = true;
  charIndex = 0;
  textEl.textContent = '';
  const line = dialogue[index];
  
  if (!line) return;

  namebox.textContent = line.name || '';
  namebox.style.display = line.name ? 'block' : 'none';

  // 1. SET PORTRAIT
  if (line.expression) {
    const portraitUrl = getFullUrl(line.expression, characterData);
    if (portrait.src !== portraitUrl) {
        portrait.src = portraitUrl;
    }
    portrait.style.display = 'block';
  } else {
    portrait.style.display = 'none';
  }

  // 2. SET BACKGROUND
  if (line.bg) {
    // Check if line.bg is an object like {file: "1"} or just the string "1"
    const bgKey = (typeof line.bg === 'object') ? line.bg.file : line.bg;
    const newBgSrc = getFullUrl(bgKey, bgData);
    
    if (!bgImg.src.includes(newBgSrc)) {
      bgImg.style.opacity = 0; 
      setTimeout(() => {
        bgImg.src = newBgSrc;
        bgImg.onload = () => { bgImg.style.opacity = 1; };
      }, 50);
    }
  }

  // 3. LOOK-AHEAD PRELOAD (The Speed Boost)
  if (index + 1 < dialogue.length) {
    const next = dialogue[index + 1];
    if (next.expression) preload(getFullUrl(next.expression, characterData));
    if (next.bg) {
      const nextBgKey = (typeof next.bg === 'object') ? next.bg.file : next.bg;
      preload(getFullUrl(nextBgKey, bgData));
    }
  }

  type();
}

function type() {
  const fullText = dialogue[index]?.text || '';
  if (charIndex < fullText.length) {
    textEl.textContent += fullText.charAt(charIndex++);
    // Type speed: 30ms
    setTimeout(type, 30);
  } else {
    typing = false;
  }
}

function nextLine() {
  if (typing) {
    // Instant finish typing
    textEl.textContent = dialogue[index].text;
    typing = false;
    return;
  }
  index++;
  if (index < dialogue.length) {
    startLine();
  } else {
    // End of script
    textbox.style.display = 'none';
    portrait.style.display = 'none';
  }
}

/** INPUTS **/
window.addEventListener('click', (e) => {
  if (textbox.style.display !== 'none') nextLine();
});

window.addEventListener('keydown', (e) => {
  if (textbox.style.display === 'none') return;
  if (e.key === ' ' || e.key === 'Enter') {
    e.preventDefault();
    nextLine();
  }
});

// Start
loadAll();
</script>
</body>
</html>
