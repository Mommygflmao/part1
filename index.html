<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pro DDLC Textbox (JSON + Character Packs + BGS)</title>
<style>
  body { margin: 0; background: #111; font-family: Arial, sans-serif; color: #fff; overflow: hidden; }
  #scene { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
  #bg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; object-fit: contain; z-index: 0; }
  #portrait { position: absolute; bottom: 200px; left: 40px; width: 300px; z-index: 2; display: none; }
  #textbox {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 900px;
    max-width: calc(100vw - 40px);
    height: 200px;
    background: #fff;
    border-top: 6px solid #f6a5c0;
    box-shadow: 0 -5px 25px rgba(0,0,0,0.4);
    border-radius: 10px 10px 0 0;
    padding: 18px 22px;
    box-sizing: border-box;
    display: none; 
    color: #222;
    z-index: 3;
  }
  #namebox {
    position: absolute;
    top: -36px;
    left: 20px;
    background: #f6a5c0;
    color: white;
    padding: 8px 16px;
    font-weight: bold;
    border-radius: 6px 6px 0 0;
    min-width: 80px;
  }
  #text { font-size: 22px; color: #222; line-height: 1.4; white-space: pre-wrap; word-break: break-word; }
  #next { position: absolute; bottom: 10px; right: 20px; font-size: 14px; opacity: 0.5; color: #222; }
</style>
</head>
<body>

<div id="scene">
  <img id="bg" alt="background" />
  <img id="portrait" alt="character portrait" />
</div>
<div id="textbox" role="region" aria-label="dialogue textbox">
  <div id="namebox"></div>
  <div id="text"></div>
  <div id="next">â–¶ Click</div>
</div>

<script>
let dialogue = [];
let characterData = {};
let imageBase = '';
let index = 0, charIndex = 0, typing = false;

const textbox = document.getElementById('textbox');
const namebox = document.getElementById('namebox');
const textEl = document.getElementById('text');
const portrait = document.getElementById('portrait');
const bg = document.getElementById('bg');

// EDIT THESE PATHS
const DIALOGUE_PATH = 'https://raw.githubusercontent.com/USERNAME/REPO/main/assets/dialogue.json'; // GitHub raw URL
const CHARACTERDATA_PATH = 'assets/characters/katz/characterdata.json';

// Fetch dialogue and character data
async function loadData() {
  try {
    const [dRes, cRes] = await Promise.all([
      fetch(DIALOGUE_PATH),
      fetch(CHARACTERDATA_PATH)
    ]);
    if (!dRes.ok) throw new Error('Failed to load dialogue.json');
    if (!cRes.ok) throw new Error('Failed to load characterdata.json');
    const d = await dRes.json();
    const c = await cRes.json();

    dialogue = Array.isArray(d.dialogue) ? d.dialogue : (Array.isArray(d) ? d : []);
    characterData = c || {};
    const lastSlash = CHARACTERDATA_PATH.lastIndexOf('/');
    imageBase = lastSlash >= 0 ? CHARACTERDATA_PATH.substring(0, lastSlash + 1) : '';

    if (dialogue.length > 0) showTextbox();
  } catch (err) {
    console.error(err);
    namebox.textContent = 'Error';
    textEl.textContent = 'Failed to load dialogue or character data.';
    textbox.style.display = 'block';
  }
}

function showTextbox(){ textbox.style.display = 'block'; startLine(); }

function startLine(){
  typing = true;
  charIndex = 0;
  textEl.textContent = '';
  const line = dialogue[index] || { name: '', text: '', bg: null };
  namebox.textContent = line.name || '';

  // Handle portrait
  if (line.expression && characterData.list && characterData.list[line.expression]) {
    portrait.src = imageBase + characterData.list[line.expression] + '.png';
    portrait.style.display = 'block';
  } else {
    portrait.style.display = 'none';
    portrait.src = '';
  }

  // Handle background
  if (line.bg && line.bg.file) {
    bg.src = line.bg.file;
    bg.style.objectFit = line.bg.scaleMode === 'fill' ? 'cover' : 'contain';
  }

  type();
}

function type(){
  const line = dialogue[index] || { text: '' };
  const text = line.text || '';
  if (charIndex < text.length){
    textEl.textContent += text.charAt(charIndex++);
    setTimeout(type, 30);
  } else {
    typing = false;
  }
}

function finishTyping(){
  const line = dialogue[index] || { text: '' };
  textEl.textContent = line.text || '';
  typing = false;
}

function nextLine(){
  if (dialogue.length === 0) return;
  if (typing){ finishTyping(); return; }
  index++;
  if (index < dialogue.length) startLine();
  else {
    textbox.style.display = 'none';
    portrait.style.display = 'none';
    document.removeEventListener('click', nextLine);
  }
}

document.addEventListener('click', nextLine);

// Load data initially
loadData();

// Optional: Auto-update every 60 seconds from GitHub
setInterval(loadData, 60000);
</script>
</body>
</html>
