<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro DDLC Textbox - JSON BG Mapping</title>
<style>
  :root {
    --textbox-width: 900px;
    --textbox-height: 200px;
    --accent: #f6a5c0;
    --bg-color: #111;
    --text-color: #222;
  }
  html,body { height:100%; margin:0; background:var(--bg-color); color:#fff; font-family: Arial, sans-serif; overflow: hidden; }
  #scene { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
  
  #bg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
    background: #000;
    transition: opacity 0.4s ease-in-out; /* Smooth transition */
  }

  #portrait {
    position: absolute;
    right: 40px;
    bottom: 120px;
    width: 28vw;
    max-width: 420px;
    min-width: 160px;
    z-index: 2;
    display: none;
    pointer-events: none;
  }

  #textbox {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: var(--textbox-width);
    max-width: calc(100vw - 40px);
    height: var(--textbox-height);
    background: #fff;
    border-top: 6px solid var(--accent);
    border-radius: 10px 10px 0 0;
    padding: 18px 22px;
    box-sizing: border-box;
    display: none;
    color: var(--text-color);
    z-index: 3;
    cursor: pointer;
  }

  #namebox {
    position: absolute;
    top: -36px;
    left: 20px;
    background: var(--accent);
    color: white;
    padding: 8px 16px;
    font-weight: bold;
    border-radius: 6px 6px 0 0;
    min-width: 80px;
  }

  #text { font-size: 22px; line-height: 1.4; white-space: pre-wrap; overflow: auto; height: 100%; }

  @media (max-width: 600px) { #portrait { display: none; } }
</style>
</head>
<body>

<div id="scene">
  <img id="bg" alt="background" />
  <img id="portrait" alt="character portrait" />
</div>

<div id="textbox">
  <div id="namebox"></div>
  <div id="text"></div>
</div>

<script>
/** CONFIG **/
const DIALOGUE_PATH = 'assets/dialogue.json';
const CHARACTER_DATA_PATH = 'assets/characters/katz/characterdata.json';
const BG_DATA_PATH = 'assets/bg/bgdata.json'; // Path to your new BG JSON

/** STATE **/
let dialogue = [];
let characterData = {};
let bgData = {};
let index = 0, charIndex = 0, typing = false;
const preloadedImages = new Set();

const textbox = document.getElementById('textbox');
const namebox = document.getElementById('namebox');
const textEl = document.getElementById('text');
const portrait = document.getElementById('portrait');
const bgImg = document.getElementById('bg');

/** PATH RESOLVER **/
function getFullUrl(key, dataObj) {
  if (!key || !dataObj.list || !dataObj.list[key]) return key;
  let file = dataObj.list[key];
  if (typeof file === 'object') file = file.file;
  
  // Add extension if missing
  if (!/(\.[a-zA-Z0-9]+)$/.test(file)) file += '.png';
  
  // Use prefix if available
  const prefix = dataObj.prefix || '';
  return prefix ? (prefix.endsWith('/') ? prefix + file : prefix + '/' + file) : file;
}

function preload(url) {
  if (!url || preloadedImages.has(url)) return;
  const img = new Image();
  img.src = url;
  preloadedImages.add(url);
}

/** LOAD DATA **/
async function loadAll() {
  try {
    const [d, c, b] = await Promise.all([
      fetch(DIALOGUE_PATH).then(r => r.json()),
      fetch(CHARACTER_DATA_PATH).then(r => r.json()),
      fetch(BG_DATA_PATH).then(r => r.json())
    ]);

    dialogue = d.dialogue || d;
    characterData = c;
    bgData = b;

    if (dialogue.length > 0) {
      textbox.style.display = 'block';
      startLine();
    }
  } catch (e) {
    console.error("Load Error:", e);
    textEl.textContent = "Error loading JSON data.";
    textbox.style.display = 'block';
  }
}

function startLine() {
  typing = true;
  charIndex = 0;
  textEl.textContent = '';
  const line = dialogue[index];
  namebox.textContent = line.name || '';

  // 1. SET PORTRAIT
  if (line.expression) {
    portrait.src = getFullUrl(line.expression, characterData);
    portrait.style.display = 'block';
  } else {
    portrait.style.display = 'none';
  }

  // 2. SET BACKGROUND (Using mapping)
  if (line.bg) {
    const bgKey = typeof line.bg === 'object' ? line.bg.file : line.bg;
    const newBgSrc = getFullUrl(bgKey, bgData);
    
    if (bgImg.src !== newBgSrc) {
      bgImg.style.opacity = 0; // Quick fade out
      setTimeout(() => {
        bgImg.src = newBgSrc;
        bgImg.style.opacity = 1; // Fade back in
      }, 100);
    }
  }

  // 3. PRELOAD NEXT ASSETS
  if (index + 1 < dialogue.length) {
    const next = dialogue[index + 1];
    if (next.expression) preload(getFullUrl(next.expression, characterData));
    if (next.bg) {
      const nextBgKey = typeof next.bg === 'object' ? next.bg.file : next.bg;
      preload(getFullUrl(nextBgKey, bgData));
    }
  }

  type();
}

function type() {
  const fullText = dialogue[index].text || '';
  if (charIndex < fullText.length) {
    textEl.textContent += fullText.charAt(charIndex++);
    setTimeout(type, 30);
  } else {
    typing = false;
  }
}

function nextLine() {
  if (typing) {
    textEl.textContent = dialogue[index].text;
    typing = false;
    return;
  }
  index++;
  if (index < dialogue.length) startLine();
  else textbox.style.display = 'none';
}

/** INPUT **/
window.addEventListener('click', nextLine);
window.addEventListener('keydown', (e) => {
  if (e.key === ' ' || e.key === 'Enter') nextLine();
});

loadAll();
</script>
</body>
</html>
